<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Pucoti</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>

  <body>
    <div id="app"></div>

    <!-- Neutralino.js client. This file is gitignored,
        because `neu update` typically downloads it.
        Avoid copy-pasting it.
        -->
    <script src="/js/neutralino.js"></script>
    <script src="/js/lib.js"></script>
    <script src="/js/main.js"></script>

    <script>
      let countdownDuration = 10 * 60 * 1000;
      let now = new Date().getTime();
      let ringTime = now + countdownDuration;

      let state = {
        countdownDuration,
        ringTime,
        intentionStart: 0,
        intentionHistory: [],
        pucotiStart: now,
        lastRung: 0,
        ringEvery: 20, // seconds
        intention: "",
        secondaryTimers: [
          "Total time",
          "Main timer",
          "On intention",
        ],
        /**
         * Set the intention.
         * @param {string} intention
         */
        setIntention(intention) {
          this.intention = intention;
          this.intentionStart = new Date().getTime();
          this.intentionHistory.push({
            intention,
            start: this.intentionStart,
          });
        },
        getTimers() {
          let now = new Date().getTime();
          return {
            "Main timer": {
              value: this.ringTime - now,
              color: "var(--timer)",
              name: "Main timer",
            },
            "Total time": {
              value: now - this.pucotiStart,
              color: "var(--total-time)",
              name: "Total time",
            },
            "On intention": {
              value: now - this.intentionStart,
              color: "var(--purpose)",
              name: "On intention",
            },
          }
        }
      };

      // Share the state globally
      window.state = state;
      state.setIntention("");
      // Check if the time is up
      let audio = new Audio("/audio/bell.mp3");

      function checkTime() {
        let now = new Date().getTime();
        if (now > state.ringTime) {
          if (now - state.lastRung > state.ringEvery * 1000) {
            window.state.lastRung = now;
            audio.currentTime = 0;
            audio.play();
            Neutralino.os.spawnProcess(
              'notify-send "Pucoti" "Time is up, after"',
            );
          }
        } else {
          state.lastRung = 0;
        }
      }

      setInterval(checkTime, 500);
    </script>
  </body>
</html>
