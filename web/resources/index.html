<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Pucoti</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>

  <body>
    <div id="app"></div>

    <!-- Neutralino.js client. This file is gitignored,
      because `neu update` typically downloads it.
      Avoid copy-pasting it.
      -->
    <script src="/js/neutralino.js"></script>
    <script src="/js/lib.js"></script>
    <script src="/js/main.js"></script>

    <script>
      let countdownDuration = 10 * 60 * 1000;
      let now = new Date().getTime();
      let ringTime = now + countdownDuration;

      let state = {
        countdownDuration,
        ringTime,
        intentionStart: 0,
        intentionHistory: [],
        pucotiStart: now,
        lastRung: 0,
        ringEvery: "20s", // seconds
        intention: "",
        secondaryTimers: [
          "Total time",
          // "Main timer",
          "On intention",
        ],
        commands: [
          {
            at: "0m",
            every: "1m",
            cmd: "notify-send 'Pucoti' 'Time was up 1+ minute ago !!'",
            lastRan: 0,
          },
        ],
        /**
         * Set the intention.
         * @param {string} intention
         */
        setIntention(intention) {
          this.intention = intention;
          this.intentionStart = new Date().getTime();
          this.intentionHistory.push({
            intention,
            start: this.intentionStart,
          });
        },
        getTimers() {
          let now = new Date().getTime();
          return {
            "Main timer": {
              value: this.ringTime - now,
              color: "var(--timer)",
              name: "Main timer",
            },
            "Total time": {
              value: now - this.pucotiStart,
              color: "var(--total-time)",
              name: "Total time",
            },
            "On intention": {
              value: now - this.intentionStart,
              color: "var(--purpose)",
              name: "On intention",
            },
          };
        },
      };

      // Share the state globally
      window.state = state;
      state.setIntention("");
      // Check if the time is up
      let audio = new Audio("/audio/bell.mp3");

      function checkTime() {
        let now = new Date().getTime();
        let timeOnCountdown = state.ringTime - now;
        if (timeOnCountdown <= 0) {
          if (now - state.lastRung > humanTimeToMs(state.ringEvery)) {
            window.state.lastRung = now;
            audio.currentTime = 0;
            audio.play();
          }
        } else {
          state.lastRung = 0;
        }

        // Check if any command should run
        state.commands.forEach((cmd) => {
          let runTime = -humanTimeToMs(cmd.at) + state.ringTime;
          if (now > runTime) {
            if (now - cmd.lastRan > humanTimeToMs(cmd.every)) {
              cmd.lastRan = now;
              try {
                Neutralino.os.spawnProcess(cmd.cmd);
              } catch (e) {
                console.error(`Could not run command: ${cmd.cmd}`, e);
              }
            }
          } else {
            cmd.lastRan = 0;
          }
        });
      }

      setInterval(checkTime, 500);
    </script>
  </body>
</html>
